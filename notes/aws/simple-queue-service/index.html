<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Related Notes   AWS Wiki  Simple Queue Service (Amazon SQS)  Amazon SQS is a message queue service used by distributed applications to exchange messages through a polling model."><title>Simple Queue Service</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://wiki.connerv.com//icon.png><link href=https://wiki.connerv.com/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://wiki.connerv.com/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://wiki.connerv.com/js/darkmode.1fd38f434cae056438590d84cdc2b105.min.js></script>
<script src=https://wiki.connerv.com/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://wiki.connerv.com/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://wiki.connerv.com/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://wiki.connerv.com/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://wiki.connerv.com/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://wiki.connerv.com/",fetchData=Promise.all([fetch("https://wiki.connerv.com/indices/linkIndex.9cb4fbbe8787f936346ca7dad0af0b9a.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://wiki.connerv.com/indices/contentIndex.0f7f57ed0a98cda2bf94f993ae9642cf.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://wiki.connerv.com",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://wiki.connerv.com",t,[{"/moc":"#4388cc"}],t?{centerForce:1.2,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:2,linkDistance:1.2,opacityScale:1,repelForce:1.2,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/wiki.connerv.com\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label placeholder><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://wiki.connerv.com/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://wiki.connerv.com/>cvwiki</a></h1><div class=spacer></div><div id=search-icon><p></p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title"/><desc id="desc"/><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title/><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title/><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Simple Queue Service</h1><p class=meta>Nov 5, 2022
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/notes/aws/simple-queue-service.md rel=noopener></a></p><ul class=tags><li><a href=https://wiki.connerv.com/tags/aws/>Aws</a></li><li><a href=https://wiki.connerv.com/tags/serverless/>Serverless</a></li><li><a href=https://wiki.connerv.com/tags/sqs/>Sqs</a></li></ul><aside class=mainTOC><details open><summary></summary><nav id=TableOfContents><ol><li><ol><li><a href=#related-notes>Related Notes</a></li></ol></li><li><a href=#simple-queue-service-amazon-sqs><strong>Simple Queue Service</strong> (Amazon SQS)</a><ol><li><a href=#consuming-messages-using-short-polling><strong>Consuming messages using short polling</strong>:</a></li><li><a href=#consuming-messages-using-long-polling><strong>Consuming messages using long polling</strong>:</a></li><li><a href=#approximatenumberofmessages-metric>ApproximateNumberOfMessages Metric</a></li><li><a href=#approximateageofoldestmessage-metric><strong>ApproximateAgeOfOldestMessage</strong> Metric</a></li></ol></li></ol></nav></details></aside><a href=#related-notes><h3 id=related-notes><span class=hanchor arialabel=Anchor># </span>Related Notes</h3></a><ul><li><a href=/notes/aws/aws-wiki/ rel=noopener class=internal-link data-src=/notes/aws/aws-wiki/>AWS Wiki</a></li></ul><a href=#simple-queue-service-amazon-sqs><h2 id=simple-queue-service-amazon-sqs><span class=hanchor arialabel=Anchor># </span><strong>Simple Queue Service</strong> (Amazon SQS)</h2></a><ul><li>Amazon SQS is a message queue service used by distributed applications to exchange messages through a polling model. It can be used to decouple sending and receiving components without requiring each component to be concurrently available.</li><li>SQS offers reliable, highly-scalable hosted queues for storing messages while they travel between applications or micro-services. SQS lets you move data between distributed applications components and helps you decouple these components. Amazon SWF is a web service that makes it easy to coordinate work across distributed application components.</li><li>Standard queues provide at-least-once delivery, which means that each message is delivered at least once. Standard queues do not, however, preserve the order of messages. This feature only applies to FIFO queues.</li><li>SQS uses short polling by default, querying only a subset of of the servers (based on a weighted random distribution) to determine whether any messages are available for inclusion in the response. Short polling works for scenarios that require higher throughput. However, you can also configure the queue to use long polling, to reduce cost.</li><li>Take note that you cannot assign a priority to individual items in an SQL queue. If you want higher priority requests, you&rsquo;ll have to implement 2 separate SQS queues, side by side. One for premium members, that is polled first, and one for free members, which is polled if the premium queue is empty.</li><li>Pairs well with Lambda in serverless stacks. Lambda supports the synchronous and asynchronous invocation of a Lambda function. You can control the invocation type only when you invoke a Lambda function. When you use an AWS service as a trigger, the invocation type is predetermined for each service.</li><li>You can use an AWS Lambda function to process messages in an Amazon Simple Queue Service (Amazon SQS) queue. Lambda event source mappings support standard queues and first-in, first-out (FIFO) queues. With Amazon SQS, you can offload tasks from one component of your application by sending them to a queue and processing them asynchronously.</li><li>Amazon SQS automatically deletes messages that have been in a queue for more than the maximum message retention period. The default message retention period is 4 days.</li></ul><a href=#consuming-messages-using-short-polling><h3 id=consuming-messages-using-short-polling><span class=hanchor arialabel=Anchor># </span><strong>Consuming messages using short polling</strong>:</h3></a><ul><li>When you consume messages from a queue using short polling, Amazon SQS samples a subset of its servers (based on a weighted random distribution) and returns messages from only those servers. Thus, a particular ReceiveMessage request might not return all of your messages. However, if you have fewer than 1,000 messages in your queue, a subsequent request will return your messages. If you keep consuming from your queues, Amazon SQS samples all of its servers, and you receive all of your messages.</li><li>The following diagram shows the short-polling behavior of messages returned from a standard queue after one of your system components makes a receive request. Amazon SQS samples several of its servers (in gray) and returns messages A, C, D, and B from these servers. Message E isn&rsquo;t returned for this request, but is returned for a subsequent request.</li><li>Short polling occurs when the WaitTimeSeconds parameter of a ReceiveMessage request is set to 0 in one of two ways:<ul><li>The <code>ReceiveMessage</code> call sets <code>WaitTimeSeconds</code> to 0.</li><li>The <code>ReceiveMessage</code> call doesn&rsquo;t set <code>WaitTimeSeconds</code>, but the queue attribute <code>ReceiveMessageWaitTimeSeconds</code> is set to 0.</li></ul></li></ul><a href=#consuming-messages-using-long-polling><h3 id=consuming-messages-using-long-polling><span class=hanchor arialabel=Anchor># </span><strong>Consuming messages using long polling</strong>:</h3></a><ul><li>When the wait time for the ReceiveMessage API action is greater than 0, long polling is in effect. The maximum long polling wait time is 20 seconds. Long polling helps reduce the cost of using Amazon SQS by eliminating the number of empty responses (when there are no messages available for a ReceiveMessage request) and false empty responses (when messages are available but aren&rsquo;t included in a response). For information about enabling long polling for a new or existing queue using the Amazon SQS console, see the Configuring queue parameters (console). For best practices, see Setting up long polling.</li><li>Long polling offers the following benefits:<ul><li>Long polling helps reduce your cost of using Amazon SQS by reducing the number of empty responses when there are no messages available in the queue before sending a response. Unless the connection times out, the response to the <code>ReceiveMessage</code> request contains at least one of the available messages, up to the maximum number of messages specified in the <code>ReceiveMessage</code> action.</li><li>Reduce empty responses by allowing Amazon SQS to wait until a message is available in a queue before sending a response. Unless the connection times out, the response to the ReceiveMessage request contains at least one of the available messages, up to the maximum number of messages specified in the ReceiveMessage action. In rare cases, you might receive empty responses even when a queue still contains messages, especially if you specify a low value for the ReceiveMessageWaitTimeSeconds parameter.</li><li>Reduce false empty responses by querying all—rather than a subset of—Amazon SQS servers.</li><li>Return messages as soon as they become available.</li></ul></li></ul><a href=#approximatenumberofmessages-metric><h3 id=approximatenumberofmessages-metric><span class=hanchor arialabel=Anchor># </span>ApproximateNumberOfMessages Metric</h3></a><ul><li>The <code>ApproximateNumberOfMessages</code> metric in Amazon CloudWatch can scale out EC2 instances in your decoupled application components.</li><li>The number of messages in your Amazon SQS queue does not solely define the number of instances needed. In fact, the number of instances in the fleet can be driven by multiple factors, including how long it takes to process a message and the acceptable amount of latency (queue delay).</li><li>The solution is to use a <em>backlog per instance</em> metric with the target value being the <em>acceptable backlog per instance</em> to maintain. You can calculate these numbers as follows:<ul><li><strong>Backlog per instance</strong>: To determine your backlog per instance, start with the SQS metric <code>ApproximateNumberOfMessages</code> to determine the length of the SQS queue (number of messages available for retrieval from the queue). Divide that number by the fleet&rsquo;s running capacity, which for an Auto Scaling group is the number of instances in the <code>InService</code> state, to get the backlog per instance.</li><li><strong>Acceptable backlog per instance</strong>: To determine your target value, first calculate what your application can accept in terms of latency. Then, take the acceptable latency value and divide it by the average time that an EC2 instance takes to process a message.</li></ul></li><li>Amazon SQS automatically deletes messages that have been in a queue for more than the maximum message retention period. The default message retention period is 4 days</li></ul><a href=#approximateageofoldestmessage-metric><h3 id=approximateageofoldestmessage-metric><span class=hanchor arialabel=Anchor># </span><strong>ApproximateAgeOfOldestMessage</strong> Metric</h3></a><ul><li>The <code>ApproximateAgeOfOldestMessage</code> metric is useful when applications have time-sensitive messages and you need to ensure that messages are processed within a specific time period. You can use this metric to set Amazon CloudWatch alarms that issue alerts when messages remain in the queue for extended periods of time. You can also use alerts to take action, such as increasing the number of consumers to process messages more quickly. With a target tracking scaling policy, you can scale (increase or decrease capacity) a resource based on a target value for a specific CloudWatch metric. To create a custom metric for this policy, you need to use AWS CLI or AWS SDKs. Take note that you need to create an AMI from the instance first before you can create an Auto Scaling group to scale the instances based on the <code>ApproximateAgeOfOldestMessage</code> metric.</li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3></h3><ul class=backlinks><li><a href=/notes/aws/aws-wiki/ data-ctx="Simple Queue Service" data-src=/notes/aws/aws-wiki class=internal-link>AWS Wiki</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3></h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://wiki.connerv.com/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p></p><ul><li><a href=https://wiki.connerv.com/></a></li></ul></footer></div></div></body></html>