<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Related Notes   AWS Wiki  CloudWatch Ingest, store and manage metrics
 Public Service - public space endpoints (can be accessed both on-prem or on AWS) Needs public internet access to access the public space endpoint AWS Service integration - management place Agent integration ."><title>CloudWatch</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://wiki.connerv.com//icon.png><link href=https://wiki.connerv.com/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://wiki.connerv.com/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://wiki.connerv.com/js/darkmode.1fd38f434cae056438590d84cdc2b105.min.js></script>
<script src=https://wiki.connerv.com/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://wiki.connerv.com/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://wiki.connerv.com/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://wiki.connerv.com/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://wiki.connerv.com/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://wiki.connerv.com/",fetchData=Promise.all([fetch("https://wiki.connerv.com/indices/linkIndex.9cb4fbbe8787f936346ca7dad0af0b9a.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://wiki.connerv.com/indices/contentIndex.e35c5bccb19f681f982844cf3e561e53.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://wiki.connerv.com",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://wiki.connerv.com",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/wiki.connerv.com\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label placeholder><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://wiki.connerv.com/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://wiki.connerv.com/>cvwiki</a></h1><div class=spacer></div><div id=search-icon><p></p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title"/><desc id="desc"/><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title/><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title/><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>CloudWatch</h1><p class=meta>Nov 5, 2022
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/notes/aws/cloudwatch.md rel=noopener></a></p><ul class=tags><li><a href=https://wiki.connerv.com/tags/aws/>Aws</a></li><li><a href=https://wiki.connerv.com/tags/aws-monitoring/>Aws monitoring</a></li><li><a href=https://wiki.connerv.com/tags/aws-logging/>Aws logging</a></li><li><a href=https://wiki.connerv.com/tags/aws-alarms/>Aws alarms</a></li></ul><aside class=mainTOC><details open><summary></summary><nav id=TableOfContents><ol><li><ol><li><a href=#related-notes>Related Notes</a></li></ol></li><li><a href=#cloudwatch><strong>CloudWatch</strong></a><ol><li><a href=#cloudwatch---data>CloudWatch - Data</a></li><li><a href=#cloudwatch-logs>CloudWatch Logs</a></li><li><a href=#cloudwatch-events-and-eventbridge>CloudWatch Events and EventBridge</a></li><li><a href=#misc-notes>Misc. Notes</a></li><li><a href=#basic-monitoring-and-detailed-monitoring>Basic Monitoring and Detailed Monitoring</a></li></ol></li><li><a href=#sysops-scenarios>#sysops Scenarios</a></li></ol></nav></details></aside><a href=#related-notes><h3 id=related-notes><span class=hanchor arialabel=Anchor># </span>Related Notes</h3></a><ul><li><a href=/notes/aws/aws-wiki/ rel=noopener class=internal-link data-src=/notes/aws/aws-wiki/>AWS Wiki</a></li></ul><a href=#cloudwatch><h2 id=cloudwatch><span class=hanchor arialabel=Anchor># </span><strong>CloudWatch</strong></h2></a><p>Ingest, store and manage metrics</p><ul><li>Public Service - public space endpoints (can be accessed both on-prem or on AWS)</li><li>Needs public internet access to access the public space endpoint</li><li>AWS Service integration - management place</li><li>Agent integration .. e.g. EC2 - richer metrics</li><li>On-Premises integration via Agent/API (custom metrics)</li><li>Application Integration via API/Agent (custom metrics)</li><li>View data via console UI, CLI, API, dashboards and anomaly detection</li><li>Alarms &mldr; react to metrics, can be used to notify or perform actions</li><li>Instances in a VPC can connect to CloudWatch via an Internet Gateway or Interface Endpoint</li><li>Supports Billing Alarms</li><li>CloudWatch recently was updated so that it can now aggregate data across AWS Regions</li></ul><a href=#cloudwatch---data><h3 id=cloudwatch---data><span class=hanchor arialabel=Anchor># </span>CloudWatch - Data</h3></a><ul><li>Namespace = container for metrics e.g. <code>AWS/EC2</code> & <code>AWS/Lambda</code> (note: custom namespaces don&rsquo;t start with <code>AWS</code>)</li><li>Datapoint, the things that CloudWatch records = Timestamp, value, (optional) unit of measure</li><li>Metrics = time ordered set of data points, like <code>CPUUtilization</code>, <code>NetworkIn, DiskWriteBytes</code> (EC2)<ul><li>Every metric has a MetricName (<code>CPUUtilization</code>) and a Namespace (<code>AWS/EC2</code>)</li></ul></li><li>Dimension .. name/value pair<ul><li>e.g. <code>CPUUtilization</code> Name=InstanceID, Value=i=111111111</li><li><code>AutoScalingGroupName</code>, <code>ImageId</code>, <code>InstanceId</code>, <code>InstanceType</code></li></ul></li><li>Resolution .. Standard (60s granularity) .. High (1s - costs more)<ul><li>Retention<ul><li>sub 60s are retained for 3 hours</li><li>60s retained for 15 days</li><li>300s (5 minutes) retained for 63 days</li><li>3600s (1 hour) retained for 455 days</li><li>As data ages, its aggregated and stored for longer with less resolution (detail matters less as data ages)</li></ul></li></ul></li><li>Statistics: aggregation over a period (e.g. <code>Min</code>, <code>Max</code>, <code>Sum</code>, <code>Average</code>)</li><li>Percentile - e.g. p95 and p99</li><li>Alarms - watches a metric over a time period<ul><li>ALARM or OK are the two states of an alarm</li><li>value of a metric vs threshold over time</li><li>Alarms that trigger to ALARM state can trigger one or more actions, triggered by EventBridge</li><li>Alarm Resolution</li></ul></li></ul><a href=#cloudwatch-logs><h3 id=cloudwatch-logs><span class=hanchor arialabel=Anchor># </span>CloudWatch Logs</h3></a><ul><li>Public Service - usable from AWS or on-premises</li><li>Store, Monitor and access logging data</li><li>AWS Integrations - EC2, VPC Flow Logs, Lambda, CloudTrail, R53 and more</li><li>OS logs on EC2 can be logged using the CloudWatch Agent (this also works for on-premises servers)</li><li>Can generate metrics based on logs - metric filter</li></ul><a href=#cloudwatch-events-and-eventbridge><h3 id=cloudwatch-events-and-eventbridge><span class=hanchor arialabel=Anchor># </span>CloudWatch Events and EventBridge</h3></a><ul><li>EventBridge is a superset of CloudWatch Events, and is replacing the service altogether. It can do additional things that CloudWatch Events alone couldn&rsquo;t, such as 3rd party events and custom applications.</li><li>If X happens, or at Y times(s) &mldr; do Z</li><li>EventBridge is &mldr; CloudWatch Events v2, start using EventBridge by default</li><li>A default Event bus for the account</li><li>In CloudWatch Events this is the only bus (implicit)</li><li>EventBridge can have additional buses</li><li>Rules match incoming events (or schedules)</li><li>Route the events to 1+ targets e.g. Lambda</li></ul><p>Default Event Bus</p><ul><li>When an EC2 changes state, an event is added to the event bus</li><li>Events themselves are just JSON structures, and can be passed to various targets (like Lambda)</li></ul><a href=#misc-notes><h3 id=misc-notes><span class=hanchor arialabel=Anchor># </span>Misc. Notes</h3></a><ul><li>CloudWatch has available Amazon EC2 Metrics for you to use for monitoring CPU utilization, Network utilization (network packets out of an EC2 instance), Disk performance, and Disk read/writes. In case you need to monitor the below items, you need to prepare a custom metric using a Perl or other shell script, as there are no ready to use metrics for:<ul><li>Memory Utilization</li><li>Disk swap utilization</li><li>Disk space utilization</li><li>Page file utilization</li><li>Log collection</li></ul></li><li>Take note that you can&rsquo;t use the default metrics of CloudWatch to monitor the SwapUtilization metric. To monitor custom metrics, you must install the CloudWatch agent on the EC2 instance. After installing the CloudWatch agent, you can now collect system metrics and log files of an EC2 instance.</li><li>Using CloudWatch alarm actions, you can create alarms that automatically stop, terminate, reboot, or recover your EC2 instances. You can use the stop or terminate actions to help you save money when you no longer need an instance to be running. You can use the reboot and recover actions to automatically reboot those instances or recover them onto new hardware if a system impairment occurs. You <em>could</em> do something such as writing a python script that queries the EC2 API for each instance status check, writing a shell script that periodically shuts down and starts instances based on certain stats, etc. but these solutions are all unnecessary to go through such lengths when CloudWatch Alarms already has such a feature for you, offered at a low cost.</li><li>If you need to collect CPU utilization of individuals processes that are running on a Linux-based EC2 server, you should use the Amazon CloudWatch agent <code>procstat</code> plugin.</li><li><a href=/notes/aws/rds rel=noopener class=internal-link data-src=/notes/aws/rds>rds</a> Enhanced Metrics that you can view in CloudWatch:<ul><li>RDS Child Processes<ul><li>Shows a summary of the RDS processes that support the DB instance, for example aurora for Amazon Aurora DB clusters and mysqld for MySQL DB instances. Process threads appear nested beneath the parent process. Process threads show CPU utilization only as other metrics are the same for all threads for the process. The console displays a maximum of 100 processes and threads. The results are a combination of the top CPU consuming and memory consuming processes and threads. If there are more than 50 processes and more than 50 threads, the console displays the top 50 consumers in each category. This display helps you identify which processes are having the greatest impact on performance.</li></ul></li><li>RDS Processes<ul><li>Shows a summary of the resources used by the RDS management agent, diagnostics monitoring processes, and other AWS processes that are required to support RDS DB instances.</li></ul></li><li>OS Processes<ul><li>Shows a summary of the kernel and system processes, which generally have minimal impact on performance.</li></ul></li></ul></li></ul><a href=#basic-monitoring-and-detailed-monitoring><h3 id=basic-monitoring-and-detailed-monitoring><span class=hanchor arialabel=Anchor># </span>Basic Monitoring and Detailed Monitoring</h3></a><ul><li><a href=https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch-metrics-basic-detailed.html rel=noopener>AWS Docs: Basic monitoring and detailed monitoring</a>
CloudWatch provides two categories of monitoring: <em>basic monitoring</em> and <em>detailed monitoring</em>.</li></ul><p>Many AWS services offer basic monitoring by publishing a default set of metrics to CloudWatch with no charge to customers. By default, when you start using one of these AWS services, basic monitoring is automatically enabled. For a list of services that offer basic monitoring, see 
<a href=https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/aws-services-cloudwatch-metrics.html rel=noopener>AWS services that publish CloudWatch metrics</a>.</p><p>Detailed monitoring is offered by only some services. It also incurs charges. To use it for an AWS service, you must choose to activate it. For more information about pricing, see 
<a href=http://aws.amazon.com/cloudwatch/pricing rel=noopener>Amazon CloudWatch pricing</a>.</p><p>Detailed monitoring options differ based on the services that offer it. For example, Amazon EC2 detailed monitoring provides more frequent metrics, published at one-minute intervals, instead of the five-minute intervals used in Amazon EC2 basic monitoring. Detailed monitoring for Amazon S3 and Amazon Managed Streaming for Apache Kafka means more fine-grained metrics.</p><p>In different AWS services, detailed monitoring also has different names. For example, in Amazon EC2 it is called detailed monitoring, in AWS Elastic Beanstalk it is called enhanced monitoring, and in Amazon S3 it is called request metrics.</p><p>Using detailed monitoring for Amazon EC2 helps you better manage your Amazon EC2 resources, so that you can find trends and take action faster. For Amazon S3 request metrics are available at one-minute intervals to help you quickly identify and act on operational issues. On Amazon MSK, when you enable the <code>PER_BROKER</code>, <code>PER_TOPIC_PER_BROKER</code>, or <code>PER_TOPIC_PER_PARTITION</code> level monitoring, you get additional metrics that provide more visibility.</p><p>The following list shows the services that offer detailed monitoring.</p><ul><li>Amazon API Gateway</li><li>Amazon CloudFront</li><li>Amazon EC2</li><li>Elastic Beanstalk</li><li>Amazon Kinesis Data Streams</li><li>Amazon MSK</li><li>Amazon S3</li></ul><a href=#sysops-scenarios><h2 id=sysops-scenarios><span class=hanchor arialabel=Anchor># </span>#sysops Scenarios</h2></a><p><strong>Question</strong>: A SysOps team is in the process of automating tasks to expedite the time to recover Amazon instances in the event of underlying hardware failure. The team must ensure that the attached Elastic IP and the private IP address of the original instance are retained after the instance is recovered. Additionally, an automated email notification should be in place to inform everyone in the SysOps team once a recovery process is triggered to run.
<strong>Answer</strong>: You can create an Amazon CloudWatch alarm that monitors an Amazon
<a href=/notes/aws/ec2/ rel=noopener class=internal-link data-src=/notes/aws/ec2/>EC2</a> instance and automatically recovers the instance if it becomes impaired due to an underlying hardware failure or a problem that requires AWS involvement to repair. Terminated instances cannot be recovered.
A recovered instance is identical to the original instance, including the instance ID, private IP addresses, Elastic IP addresses, and all instance metadata. If the impaired instance has a public IPv4 address, the instance retains the public IPv4 address after recovery. If the impaired instance is in a placement group, the recovered instance runs in the placement group.
When the <code>StatusCheckFailed_System</code> alarm is triggered, and the recovery action is initiated, you will be notified by the Amazon SNS topic that you selected when you created the alarm and associated the recover action. During instance recovery, the instance is migrated during an instance reboot, and any data that is in-memory is lost. When the process is complete, information is published to the SNS topic you&rsquo;ve configured for the alarm. Anyone who is subscribed to this SNS topic will receive an email notification that includes the status of the recovery attempt and any further instructions. You will notice an instance reboot on the recovered instance.
It&rsquo;s worth noting here that the <code>StatusCheckFailed_Instance</code> metric in CloudWatch just monitors the software and network configuration of your individual instance. It does not detect if the underlying hardware failed.</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3></h3><ul class=backlinks><li><a href=/notes/aws/aws-wiki/ data-ctx=CloudWatch data-src=/notes/aws/aws-wiki class=internal-link>AWS Wiki</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3></h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://wiki.connerv.com/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p></p><ul><li><a href=https://wiki.connerv.com/></a></li></ul></footer></div></div></body></html>