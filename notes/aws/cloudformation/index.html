<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Related Notes   AWS Wiki  Resources   CloudFormation Docs  CloudFormation User Guide   CloudFormation Template Reference    CloudFormation  CloudFormation begins with a template, which is a document written in JSON or YAML."><title>CloudFormation</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://wiki.connerv.com//icon.png><link href=https://wiki.connerv.com/styles.708c2658f93e3a9d323a1f9fded8f4b2.min.css rel=stylesheet><link href=https://wiki.connerv.com/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://wiki.connerv.com/js/darkmode.1fd38f434cae056438590d84cdc2b105.min.js></script>
<script src=https://wiki.connerv.com/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://wiki.connerv.com/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://wiki.connerv.com/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://wiki.connerv.com/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://wiki.connerv.com/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://wiki.connerv.com/",fetchData=Promise.all([fetch("https://wiki.connerv.com/indices/linkIndex.9cb4fbbe8787f936346ca7dad0af0b9a.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://wiki.connerv.com/indices/contentIndex.022bc7211a3a7257985d6b00a0b1da6e.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://wiki.connerv.com",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!0;drawGraph("https://wiki.connerv.com",t,[{"/moc":"#4388cc"}],t?{centerForce:2,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:2,linkDistance:1.2,opacityScale:1,repelForce:1.2,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/wiki.connerv.com\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label placeholder><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://wiki.connerv.com/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://wiki.connerv.com/>cvwiki</a></h1><div class=spacer></div><div id=search-icon><p></p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title"/><desc id="desc"/><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title/><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title/><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>CloudFormation</h1><p class=meta>Nov 5, 2022
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/notes/aws/cloudformation.md rel=noopener></a></p><ul class=tags><li><a href=https://wiki.connerv.com/tags/aws/>Aws</a></li><li><a href=https://wiki.connerv.com/tags/infrastructure-as-code/>Infrastructure as code</a></li></ul><aside class=mainTOC><details open><summary></summary><nav id=TableOfContents><ol><li><ol><li><a href=#related-notes>Related Notes</a></li></ol></li><li><a href=#resources>Resources</a></li><li><a href=#cloudformation>CloudFormation</a><ol><li><a href=#non-portable-template-example>Non-Portable Template Example</a></li><li><a href=#template-parameters-and-pseudo-parameters>Template Parameters and Pseudo Parameters</a></li><li><a href=#intrinsic-functions>Intrinsic Functions</a></li><li><a href=#mappings>Mappings</a></li><li><a href=#outputs>Outputs</a></li><li><a href=#conditions>Conditions</a></li><li><a href=#depends-on>Depends On</a></li><li><a href=#wait-conditions-creation-policies--cfn-signal>Wait Conditions, Creation Policies & cfn-signal</a></li><li><a href=#nested-stacks-reuses-the-code-not-the-resources>Nested Stacks (reuses the code, not the resources)</a></li><li><a href=#cross-stack-references-reuse-the-actual-resources-in-another-stack>Cross-Stack References (reuse the actual resources in another stack)</a></li><li><a href=#stack-sets-cloudformation-stacks-across-aws-accounts--regions>Stack Sets (CloudFormation stacks across AWS accounts & regions)</a></li><li><a href=#deletion-policy-tune-resource-deletion-to-take-backups-to-prevent-data-loss-during-stack-delete-operations>Deletion Policy: Tune resource deletion to take backups, to prevent data loss during stack delete operations</a></li><li><a href=#stack-roles>Stack Roles</a></li><li><a href=#cfn-init-run-once-to-bootstrap-an-ec2-instance-configure-install-dependencies-etc>cfn-init: Run once to bootstrap an EC2 instance (configure, install dependencies, etc.)</a></li><li><a href=#cfn-hup-trigger-a-cfn-init-operation-when-ec2-metadata-changes-are-detected-during-stack-update-operations>cfn-hup: Trigger a <code>cfn-init</code> operation when EC2 metadata changes are detected during stack update operations</a></li><li><a href=#changesets-preview-changes-to-a-template>ChangeSets: Preview changes to a template</a></li><li><a href=#custom-resources-extend-the-functionality-of-cloudformation-beyond-things-it-natively-supports>Custom Resources: Extend the functionality of CloudFormation beyond things it natively supports</a></li></ol></li><li><a href=#sysops-scenarios>#sysops Scenarios</a></li></ol></nav></details></aside><a href=#related-notes><h3 id=related-notes><span class=hanchor arialabel=Anchor># </span>Related Notes</h3></a><ul><li><a href=/notes/aws/aws-wiki/ rel=noopener class=internal-link data-src=/notes/aws/aws-wiki/>AWS Wiki</a></li></ul><a href=#resources><h2 id=resources><span class=hanchor arialabel=Anchor># </span>Resources</h2></a><ul><li><a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/Welcome.html rel=noopener>CloudFormation Docs</a></li><li><a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html rel=noopener>CloudFormation User Guide</a><ul><li><a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-reference.html rel=noopener>CloudFormation Template Reference</a></li></ul></li></ul><a href=#cloudformation><h2 id=cloudformation><span class=hanchor arialabel=Anchor># </span>CloudFormation</h2></a><ul><li>CloudFormation begins with a template, which is a document written in JSON or YAML.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Instance</span><span class=p>:</span><span class=w> </span><span class=c>## Name of the logical resource (Can be anything)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;AWS::EC2::Instance&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nt>ImageId</span><span class=p>:</span><span class=w> </span>!<span class=l>Ref LatestAmiId</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nt>InstanceType</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;t3.micro&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>KeyName</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;A4L&#39;</span><span class=w> </span><span class=c>## SSH key to use</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>The above CloudFormation Template can be used to create many different Stacks. A Stack creates, updates, and deletes physical resources based on logical resources in the template.</li><li>Once a logical resource moves to <code>create_complete</code> (meaning the physical resource is active), it can be queried for attributes of the physical resource within the template.</li><li>Keep in mind that when a Stack is deleted, the physical resources that it manages in the AWS Cloud are also deleted.</li></ul><a href=#non-portable-template-example><h3 id=non-portable-template-example><span class=hanchor arialabel=Anchor># </span>Non-Portable Template Example</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Bucket</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;AWS::S3::Bucket&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nt>BucketName</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;accatpics13333337&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Instance</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;AWS::EC2::Instance&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>KeyName</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;A4L&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nt>InstanceType</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;t2.micro&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nt>ImageId</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ami-04d29b6f966df1537&#39;</span><span class=w> </span><span class=c>## AMI ID for Amazon Linux 2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#template-parameters-and-pseudo-parameters><h3 id=template-parameters-and-pseudo-parameters><span class=hanchor arialabel=Anchor># </span>Template Parameters and Pseudo Parameters</h3></a><ul><li>Both parameter types allow inputs into CloudFormation templates</li><li>These parameters can be used in a complementary way</li></ul><a href=#template-parameters><h4 id=template-parameters><span class=hanchor arialabel=Anchor># </span>Template Parameters</h4></a><ul><li>Template Parameters accept input from the console / CLI / API when the stack is created or updated<ul><li>Can be referenced from within Logical Resources to influence Physical Resources</li><li>Can be configured with Defaults, AllowedValues, Min and Max length, AllowedPatterns, NoEcho (masked passwords) & Type</li><li>Example of Template Parameters below</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>InstanceType</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>String</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Default</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;t3.micro&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>AllowedValues</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span>- <span class=s1>&#39;t3.micro&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span>- <span class=s1>&#39;t3.medium&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span>- <span class=s1>&#39;t3.large&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Description</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;Pick a supported InstanceType&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>InstanceAmiId</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>String</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Description</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;AMI ID For Instances.&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#pseudo-parameters><h4 id=pseudo-parameters><span class=hanchor arialabel=Anchor># </span>Pseudo Parameters</h4></a><ul><li>Injected by AWS into the template or stack</li><li><code>AWS::Region</code> and <code>AWS::AccountId</code> are examples of Pseudo Parameters.</li></ul><a href=#best-practices><h4 id=best-practices><span class=hanchor arialabel=Anchor># </span>Best Practices</h4></a><ul><li>Wherever possible, use Default Template Parameters and Pseudo Parameters to reduce user input. For example, hardcoding region names is a bad practice. Use <code>Fn::GetAZs</code>.</li></ul><a href=#intrinsic-functions><h3 id=intrinsic-functions><span class=hanchor arialabel=Anchor># </span>Intrinsic Functions</h3></a><ul><li>Allows you to gain access to data at runtime</li><li>Functions can be used together or in isolation</li><li><code>Ref</code> & <code>Fn::GetAtt</code><ul><li>Using <code>!Ref</code> on template or pseudo parameters returns their value. When used with logical resources - the physical ID is usually returned, the primary value.<ul><li>For an EC2 instance, <code>!Ref Instance</code> would return the physical ID of the resource: <code>i-1234567890abcdef0</code></li></ul></li><li><code>!GetAtt</code> can be used to retrieve any attribute associated with the resource. Most logical resources return detailed configuration of the physical resource.<ul><li>For an EC2 instance, <code>!GetAtt</code> LogicalResource.Attribute could be used to return the PublicIP <code>52.91.129.183</code> or PublicDnsName <code>52.91.129.183</code>.</li></ul></li></ul></li><li><code>Fn::Join</code> & <code>Fn::Split</code><ul><li>Split accepts a single value delimiter and a string, and returns a list. Classic split function.</li><li>Join is the reverse, you provide a delimiter and list of values, and a string is returned.<ul><li>Example Usage (to form a URL): <code>Value: !Join [ '', 'https://', !GetAtt Instance.DNSName ] ]</code></li></ul></li></ul></li><li><code>Fn::GetAZs</code> & <code>Fn::Select</code> (commonly used to pick from a list of availability zones in a given region)<ul><li><code>Fn::GetAZs</code> is an environment aware function.<ul><li>Example Usage: <code>AvailabilityZone: !Select [ 0, !GetAZs '' ]</code></li></ul></li></ul></li><li>Conditions (Fn::IF, AND, Equals, Not & Or)</li><li><code>Fn::Base64</code> & <code>Fn::Sub</code><ul><li>Base64 converted plaintext to Base64 encoded text<ul><li>Sub replaces variables inside of a string with a variable<ul><li>You can&rsquo;t do self references with Sub</li></ul></li></ul></li></ul></li><li><code>Fn::Cidr</code><ul><li>In the below example, We&rsquo;re referencing the CIDR Block that we&rsquo;ve just created to create a subnets. The 16 is how many subnet to generate, and the 12 is Bits per CIDR (32 - 12 = /20)</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>VPC</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>AWS::EC2::VPC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=nt>CidrBlock</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.16.0.0/16&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Subnet1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>AWS::EC2::Subnet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>CidrBlock</span><span class=p>:</span><span class=w> </span>!<span class=l>Select [ &#34;0&#34;, !Cidr [ !GetAtt VPC.CidrBlock, &#34;16&#34;, &#34;12&#34; ] ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>VpcId</span><span class=p>:</span><span class=w> </span>!<span class=l>Ref VPC</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#mappings><h3 id=mappings><span class=hanchor arialabel=Anchor># </span>Mappings</h3></a><ul><li>Templates can contain a Mappings object which contain many mappings, which map keys to values, allowing lookup</li><li>Can have one key, or Top & Second Level</li><li>Mappings use the !FindInMap intrinsic function</li><li>Common use is to retrieve AMI for given region & architecture</li><li>Improves Template Portability</li><li>Example Syntax: <code>!FindInMap [ MapName, TopLevelKey, SecondLevelKey ]</code> might be used like this <code>!FindInMap [ "RegionMap", !Ref "AWS::Region", "HVM64"]</code> to retrieve an AMI for a certain region and architecture type for an EC2 instance.<ul><li>The third parameter is not required, if omitted, the entire map object that corresponds to the TopLevelKey will be returned.</li></ul></li></ul><a href=#outputs><h3 id=outputs><span class=hanchor arialabel=Anchor># </span>Outputs</h3></a><ul><li>Optional, but useful for providing status information</li><li>Values can be declared in this section that are visible as outputs when using the CLI</li><li>Visible as outputs in the console UI</li><li>Accessible from a parent stack when using nesting</li><li>Can be exported, allowing cross-stack references</li></ul><p>Example Output</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Outputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>WordpressURL</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Instance Web URL&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Value</span><span class=p>:</span><span class=w> </span>!<span class=l>Join [ &#39;&#39;, &#39;https://&#39;, !GetAtt Instance.DNSName ] ]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>In this example, description will be visible from the CLI and Console UI & passed back to parent stack when nested stacks are used</li></ul><a href=#conditions><h3 id=conditions><span class=hanchor arialabel=Anchor># </span>Conditions</h3></a><ul><li>Allows a stack to react to certain conditions and change infrastructure when deployed, or specific configurations of that infrastructure</li><li>Declared in an optional section of the template, the <code>Conditions</code> sections. This section is processed before resources are created</li><li>Uses the other intrinsic functions of AND, EQUALS, IF, NOT, OR</li><li>Associated with logical resources to control if they are created or not</li><li>For example, PROD or DEV could control the size of instances created within a stack</li><li>Conditions can be nested, so that a condition is only true if two other conditions are true, for example</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>EnvType</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Default</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;dev&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>String</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>AllowedValues</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;dev&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;prod&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>IsProd</span><span class=p>:</span><span class=w> </span>!<span class=l>Equals</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- !<span class=l>Ref EnvType</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;prod&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Wordpress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;AWS::EC2::Instance&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Condition</span><span class=p>:</span><span class=w> </span><span class=l>IsProd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ImageId</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;whatever&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#depends-on><h3 id=depends-on><span class=hanchor arialabel=Anchor># </span>Depends On</h3></a><ul><li>CloudFormation tries to run in parallel for create, update and delete operations</li><li>While doing this, it tries to determine dependency order automatically</li><li>This cannot always be done however. !Ref, for example, creates an implicit dependency</li><li>An Elastic IP requires an IGW attached to a VPC in order to work, but if there is no explicit dependency in the template using DependsOn, it won&rsquo;t work (This is on the #sysops exam).</li></ul><a href=#wait-conditions-creation-policies--cfn-signal><h3 id=wait-conditions-creation-policies--cfn-signal><span class=hanchor arialabel=Anchor># </span>Wait Conditions, Creation Policies & cfn-signal</h3></a><ul><li>Allows systems to provide more details about resource completion to CloudFormation</li><li>The cfn-signal command is included with the AWS CFN bootstrap package</li><li>Allows you to configure CloudFormation to wait for N number of success signals</li><li>Wait for Timeout H:M:S for those signals (12 hours max)</li><li>If all success signals are received, the CREATE_COMPLETE signal goes out!</li><li>cfn-signal is a utility running on the EC2 instance itself, explicitly sends a signal or signals to back to the CloudFormation service. If it communicates a failure, then the creation of the resource in the stack fails, and the creation of the stack itself fails.</li><li>If the timeout period is reached, the creation of the resource and the stack itself fails.</li><li>For provisioning EC2 or AutoScaling Groups, it&rsquo;s recommended to use a CreationPolicy. CreationPolicies are generally simpler to manage</li></ul><a href=#creationpolicy-example><h5 id=creationpolicy-example><span class=hanchor arialabel=Anchor># </span>CreationPolicy Example:</h5></a><ul><li>In the below example, the CreationPolicy applies signal requirement of 3 and a timeout of 15 minutes.</li><li>The ASG provisions 3 EC2 instances, each signalling once via cfn-signal</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>AutoScalingGroup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>AWS::AutoScaling::AutoScalingGroup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>... (stuff here)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DesiredCapacity</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>MinSize</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>MaxSize</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;4&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>CreationPolicy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ResourceSignal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=nt>Count</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Timeout</span><span class=p>:</span><span class=w> </span><span class=l>PT15M </span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>LaunchConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Type</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>AWS::AutoScaling::LaunchConfiguration  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=l>... (stuff here)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>UserData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=s2>&#34;Fn::Base64&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			  </span>!<span class=l>Sub |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			    </span><span class=c>#/bin/bash -xe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=l>yum update -y aws-cfn-bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=l>... (&#39;some bootstrapping&#39;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=l>/opt/aws/bin/cfn-signal -e $?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span>--<span class=l>stack ${AWS::StackName}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span>--<span class=l>resource AutoScalingGroup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span>--<span class=l>region ${AWS::Region}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#waitcondition-example><h5 id=waitcondition-example><span class=hanchor arialabel=Anchor># </span>WaitCondition Example:</h5></a><ul><li>WaitCondition can depend on other resources. Other resources can depend on the WaitCondition.</li><li>The WaitHandle generates a PreSigned URL for resource signals</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>WaitCondition</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>AWS::CloudFormation::WaitCondition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DependsOn</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;someresource&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=nt>Handle</span><span class=p>:</span><span class=w> </span>!<span class=l>Ref &#34;WaitHandle&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Timeout</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;300&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Count</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>WaitHandle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>AWS::CloudFormation::WaitConditionHandle</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><a href=#nested-stacks-reuses-the-code-not-the-resources><h3 id=nested-stacks-reuses-the-code-not-the-resources><span class=hanchor arialabel=Anchor># </span>Nested Stacks (reuses the code, not the resources)</h3></a><ul><li>CloudFormation stacks are isolated by default. You cannot reuse resources in another stack or reference other stacks by default.</li><li>A CloudFormation stack is usually isolated, meaning it contains all the resources that are needed for an application.</li><li>In this paradigm, all resources in a single stack share a lifecycle.</li><li>However, there is a limit of 500 resources per stack.</li><li>Additionally, you can&rsquo;t easily reuse resources (e.g. A VPC)</li></ul><a href=#cfn-nested-stacks><h5 id=cfn-nested-stacks><span class=hanchor arialabel=Anchor># </span>CFN Nested Stacks</h5></a><ul><li>Parent Stack / Root Stack is anything that has it&rsquo;s own nested stack</li><li>There is nothing special about this stack type. It is the same as any other stack, but it creates additional stacks like the one below.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>VPCSTACK</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>AWS::CloudFormation::Stack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>TemplateURL</span><span class=p>:</span><span class=w> </span><span class=l>https://someurl.com/template.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Param1</span><span class=p>:</span><span class=w> </span>!<span class=l>Ref SomeParam1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Param2</span><span class=p>:</span><span class=w> </span>!<span class=l>Ref SomeParam2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Param3</span><span class=p>:</span><span class=w> </span>!<span class=l>Ref SomeParam3</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>By doing this, you can reference outputs from your nested VPC stack (NOTE: You cannot reference logical resources created in any of the nested stacks).</li><li>You can many many nested stacks created in your root stack, and if another stack depends on the VPCSTACK, for example, you can pass outputs from that stack into another nested stack that exists within the root stack.</li><li>By breaking up solutions into modular templates, it means these templates can be resources again and again for different deployments. Many nested stack architectures can use that template. Note that the resources themselves aren&rsquo;t being reused, just the template. A separate VPC would be created, for example, if you were to use this template in a different stack.</li><li>Only use Nested Stacks when the stacks are lifecycle linked.</li><li>Nested Stacks are used when lifecycles are linked. If they aren&rsquo;t you may want to use cross-stack references instead.</li></ul><a href=#cross-stack-references-reuse-the-actual-resources-in-another-stack><h3 id=cross-stack-references-reuse-the-actual-resources-in-another-stack><span class=hanchor arialabel=Anchor># </span>Cross-Stack References (reuse the actual resources in another stack)</h3></a><ul><li>If you want to use the same VPC across multiple architectures, cross-stack references are probably better suited for this aim.</li><li>Because of the isolation of stacks, outputs are normally not visible from other stacks</li><li>Outputs can be exported, making them visible from other stacks</li><li>Export is used to export the output of a stack. Exported outputs must have a unique name in the region</li><li>Anything that we want to use outside of the stack, we need to set as an export:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Outputs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>SHAREDVPCID</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Description</span><span class=p>:</span><span class=w> </span><span class=l>Shared Services VPC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Value</span><span class=p>:</span><span class=w> </span>!<span class=l>Ref VPC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>Export</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  </span><span class=nt>Name</span><span class=p>:</span><span class=w> </span><span class=l>SHAREDVPC</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>To reference an exported output in another stack, use the <code>Fn::ImportValue</code> instead of <code>Ref</code>. This can only be done in the same region and AWS account.</li></ul><a href=#stack-sets-cloudformation-stacks-across-aws-accounts--regions><h3 id=stack-sets-cloudformation-stacks-across-aws-accounts--regions><span class=hanchor arialabel=Anchor># </span>Stack Sets (CloudFormation stacks across AWS accounts & regions)</h3></a><ul><li>Deploy CFN stacks across many accounts & regions</li><li>StackSets are containers that live in an admin AWS account</li><li>StackSets can contain many Stack Instances, which are not Stacks. They are &ldquo;Reference Stacks&rdquo;, which is a container for an individual stacks that run in a particular region, in a particular account.</li><li>Stack instances & stacks are in &ldquo;Target Accounts&rdquo;</li><li>Each stack = 1 region in 1 account</li><li>Permissions for these kind of cross account operations are granted via self-managed IAM Roles or service managed IAM roles within an organization</li><li>TERM: Concurrent Accounts, an integer<ul><li>This defines how many individual AWS accounts can be deployed into, at the same time</li><li>The higher this value, the faster your cross account deployment</li></ul></li><li>TERM: Failure Tolerance, an integer<ul><li>The amount of individual deployments that can fail, before the entire deployment is considered a failure</li></ul></li><li>TERM: Retain Stacks, boolean<ul><li>Remove stack instances from a stack set, by default, any stacks will be deleted from the account.<ul><li>If true, stacks will be retained when you remove the StackSet from an AWS account
Scenario: Enable AWS Config
Scenario: AWS Config Rules - MFA, EIPS, EBS Encryption
Scenario: Create IAM Roles for cross-account access</li></ul></li></ul></li></ul><a href=#deletion-policy-tune-resource-deletion-to-take-backups-to-prevent-data-loss-during-stack-delete-operations><h3 id=deletion-policy-tune-resource-deletion-to-take-backups-to-prevent-data-loss-during-stack-delete-operations><span class=hanchor arialabel=Anchor># </span>Deletion Policy: Tune resource deletion to take backups, to prevent data loss during stack delete operations</h3></a><ul><li>If you delete a logical resource from a template, by default, the physical resource is deleted</li><li>This can cause data loss, with RDS, example</li><li>With deletion policy, you can define on each resource</li><li>Delete (Default), Retain or (if supported) Snapshot</li><li>Some of the resources that support snapshots are:<ul><li>EBS Volumes</li><li>Elasticache</li><li>Neptune</li><li>RDS</li><li>Redshift</li></ul></li><li>If you delete a stack, with Snapshot selected, the Snapshot will persist past the deletion of the stack. It is your responsibility to clean up these snapshot resources.</li><li>The above applies to Delete, not Replace!</li></ul><a href=#stack-roles><h3 id=stack-roles><span class=hanchor arialabel=Anchor># </span>Stack Roles</h3></a><ul><li>CloudFormation uses the permissions of the logged in identity, which means you or the role you&rsquo;ve assumed, need permissions to interact with Stacks, and the resources that the stacks create themselves</li><li>CloudFormation can assume a role to gain the permissions, which lets you implement role separation</li><li>The identity creating the stack doesn&rsquo;t need the resource permissions - only <code>PassRole</code></li><li>Stack roles allow an IAM role to be passed into the stack via <code>PassRole</code></li><li>A stack uses this role, rather than the identity interacting with the stack to create, update and delete AWS resources.</li><li>It allows role separation, and is a powerful security feature.</li></ul><a href=#cfn-init-run-once-to-bootstrap-an-ec2-instance-configure-install-dependencies-etc><h3 id=cfn-init-run-once-to-bootstrap-an-ec2-instance-configure-install-dependencies-etc><span class=hanchor arialabel=Anchor># </span>cfn-init: Run once to bootstrap an EC2 instance (configure, install dependencies, etc.)</h3></a><ul><li><code>cfn-init</code> is run once as part of bootstrapping (user data) an EC2 instance (only run once, even if you update the template)</li><li>CloudFormation init is a native CloudFormation feature</li><li>Configuration directives stored in template</li><li><code>AWS::CloudFormation::Init</code> part of logical resource, and here you can specify directives of what can happen on the system</li><li>User data is procedural - the HOW</li><li>Init on the other hand, is a desired state - the WHAT (works across platform, even across linux/windows)</li><li>If something already exists on instance that CloudFormation init wants, it will ignore it<ul><li>If apache is installed for example, and CloudFormation init wants to install apache, nothing will happen, since it&rsquo;s already installed</li></ul></li><li><code>cfn-init</code> helper script is installed on EC2 OS (makes it so). This is executed via user data</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>EC2Instance</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Type</span><span class=p>:</span><span class=w> </span><span class=l>AWS::EC2::Instance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>CreationPolicy</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>AWS::CloudFormation::Init</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configSets</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w> </span><span class=c># defines which configkeys to use and in which order to apply</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>install_cfn</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>software_install</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configure_instance</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>install_wordpress</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>configure_wordpress</span><span class=p>:</span><span class=w> </span><span class=l>...</span><span class=w> </span><span class=c># this is an example of a config key</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>The below is ran on EC2 startup:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>UserData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Fn::Base64</span><span class=p>:</span><span class=w> </span>!<span class=l>Sub |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#!/bin/bash -xe</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>yum -y update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>/opt/aws/bin/cfn-init -v --stack ${AWS::StackId} --resource EC2Instance --configsets wordpress_install --region ${AWS::Region}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>/opt/aws/bin/cfn-signal -e --stack ${AWS::StackId} --resource EC2Instance --region ${AWS::Region}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ConfigKey could contain the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>packages:
</span></span><span class=line><span class=cl> .. &#39;packages to install&#39;
</span></span><span class=line><span class=cl>groups:
</span></span><span class=line><span class=cl> .. &#39;local group mgmt&#39;
</span></span><span class=line><span class=cl>users:
</span></span><span class=line><span class=cl> .. &#39;local user mgmt&#39;
</span></span><span class=line><span class=cl>sources:
</span></span><span class=line><span class=cl> .. &#39;download and extract archives&#39;
</span></span><span class=line><span class=cl>files:
</span></span><span class=line><span class=cl> .. &#39;files to create&#39;
</span></span><span class=line><span class=cl>commands:
</span></span><span class=line><span class=cl> .. &#39;commands to execute&#39;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl> .. &#39;services to enable&#39;
</span></span></code></pre></td></tr></table></div></div><a href=#cfn-hup-trigger-a-cfn-init-operation-when-ec2-metadata-changes-are-detected-during-stack-update-operations><h3 id=cfn-hup-trigger-a-cfn-init-operation-when-ec2-metadata-changes-are-detected-during-stack-update-operations><span class=hanchor arialabel=Anchor># </span>cfn-hup: Trigger a <code>cfn-init</code> operation when EC2 metadata changes are detected during stack update operations</h3></a><ul><li><code>cfn-hup</code> helper is a daemon which must be installed and configured yourself (unlike <code>cfn-init</code>, which is natively available on EC2)</li><li>Detects changes in resource metadata, and runs configurable actions when a change is detected at stack update time</li><li>When a template is changed, an <code>UpdateStack</code> operation is ran, <code>cfn-hup</code> then checks metadata periodically, when updated, it calls <code>cfn-init</code>, and <code>cfn-init</code> applies the new configuration.</li><li>Normal user data is, by default, only executed once per stack. If you want to monitor the logical resource and initiate a new <code>cfn-init</code> when configuration updates occur in the metadata, you must install and configure <code>cfn-hup</code>.</li></ul><a href=#changesets-preview-changes-to-a-template><h3 id=changesets-preview-changes-to-a-template><span class=hanchor arialabel=Anchor># </span>ChangeSets: Preview changes to a template</h3></a><ul><li>When a stack is updated, 1 of 3 things may happen. No interruption, some interruption, or full replacement of resources. ChangeSets, let you apply a new template to a stack, such that when you&rsquo;re about to apply a stack, you can preview what is about to happen when the template is updated.</li><li>After creating a ChangeSet, you can then choose to apply the changes by executing the change set.</li><li>Similar to the Terraform plan command, which outputs a plan file that then can be passed to a Terraform apply command.</li></ul><a href=#custom-resources-extend-the-functionality-of-cloudformation-beyond-things-it-natively-supports><h3 id=custom-resources-extend-the-functionality-of-cloudformation-beyond-things-it-natively-supports><span class=hanchor arialabel=Anchor># </span>Custom Resources: Extend the functionality of CloudFormation beyond things it natively supports</h3></a><ul><li>CloudFormation doesn&rsquo;t support everything in AWS</li><li>Custom Resources are a type of logical resource that allows CloudFormation to do things that it doesn&rsquo;t natively support</li><li>Passes event data to something, and gets data back from something. This could be a Lambda function or SNS topic, for example.</li><li>The compute that is backing that custom resource, can pass a success or failure code back to CloudFormation.</li><li>The data that is sent back from the custom resource can then be referenced elsewhere in your template, just like any other resource.</li><li>One application of this, is automating the process by which objects are uploaded to an S3 bucket. Normally, S3 has a limitation such that it does not want to let CloudFormation delete a bucket that is not empty. How to use Custom Resources to get around this? We would use a Custom Resource, backed by a Lambda function, that uploads resources that we want inside of the S3 bucket. Then, we apply the template. Now, when we go to delete the bucket, CloudFormation knows the the CustomResource depends on the bucket. When CloudFormation deletes the stack, the Lambda now knows that the stack is being deleted, so it use that information to delete the objects in the bucket. At that point, the stack will delete the S3 bucket, which will succeed, because it is empty.</li></ul><a href=#sysops-scenarios><h2 id=sysops-scenarios><span class=hanchor arialabel=Anchor># </span>#sysops Scenarios</h2></a><p><strong>Question</strong>: A SysOps Administrator needs to install and configure software applications to an EC2 instance that will be deployed using CloudFormation. The Administrator has to ensure that the applications are properly running before the stack creation proceeds. Which of the following options can satisfy the given requirement?</p><p><strong>Answer</strong>: Add a <code>CreationPolicy</code> attribute to the instance then send a success signal after the applications are installed and configured. Use the <code>cfn-signal</code> helper script to signal a resource.</p><p>You can associate the <code>CreationPolicy</code> attribute with a resource to prevent its status from reaching create complete until AWS CloudFormation receives a specified number of success signals or the timeout period is exceeded. To signal a resource, you can use the <code>cfn-signal</code> helper script or SignalResource API. AWS CloudFormation publishes valid signals to the stack events so that you track the number of signals sent.</p><p>The creation policy is invoked only when AWS CloudFormation creates the associated resource. Currently, the only AWS CloudFormation resources that support creation policies are <code>AWS::AutoScaling::AutoScalingGroup</code>, <code>AWS::EC2::Instance</code>, and <code>AWS::CloudFormation::WaitCondition</code>.</p><p>Use the <code>CreationPolicy</code> attribute when you want to wait on resource configuration actions before the stack creation proceeds. For example, if you install and configure software applications running on an EC2 instance, you might want those applications to be running before proceeding. In such cases, you can add a <code>CreationPolicy</code> attribute to the instance, and then send a success signal to the instance after the applications are installed and configured.</p><hr><p><strong>Question</strong>: A SysOps Administrator needs to create a CloudFormation template that should automatically rollback in the event that the entire stack failed to launch. The application stack requires the pre-requisite packages to be installed first in order for it to run properly, which could take about an hour or so to complete.</p><p>What should the Administrator add in the template to accomplish this requirement?</p><p><strong>Answer</strong>: In the <code>ResourceSignal</code> parameter of the <code>CreationPolicy</code> resource attribute, add a <code>Timeout</code> property with a value of 2 hours.</p><p>Associate the <code>CreationPolicy</code> attribute with a resource to prevent its status from reaching create complete until AWS CloudFormation receives a specified number of success signals or the timeout period is exceeded. To signal a resource, you can use the <code>cfn-signal</code> helper script or <code>ScriptResource</code> API. AWS CloudFormation publishes valid signals to the stack events so that you track the number of signals sent.</p><p>The creation policy is invoked only when AWS CloudFormation creates the associated resource. Currently, the only AWS CloudFormation resources that support creation policies <code>AWS::AutoScaling::AutoScalingGroup</code>, <code>AWS::EC2::Instance</code>, <code>AWS::CloudFormation::WaitCondition</code>.</p><p>Use the <code>CreationPolicy</code> attribute when you want to wait on resource configuration actions before stack creation proceeds. For example, if you install and configure software applications on an EC2 instance, you might want those applications to be running before proceeding. In such cases, you can add a <code>CreationPolicy</code> attribute to the instance, and then send a success signal to the instance after the applications are installed and configured.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CreationPolicy:
</span></span><span class=line><span class=cl>  AutoScalingCreationPolicy:
</span></span><span class=line><span class=cl>    MinSuccessfulInstancesPercent: Integer
</span></span><span class=line><span class=cl>  ResourceSignal:
</span></span><span class=line><span class=cl>    Count: Integer
</span></span><span class=line><span class=cl>    Timeout: String
</span></span></code></pre></td></tr></table></div></div><p>The <code>Timeout</code> property is the length of time that AWS CloudFormation waits for the number of signals that were specified in the <code>Count</code> property. The timeout period starts after AWS CloudFormation starts creating the resource, and the timeout expires no sooner than the time you specify but can occur shortly thereafter. The maximum time that you can specify is 12 hours.</p><hr><p><strong>Question</strong>: A SysOps Administrator has been instructed to handle the deployment of the cloud resources in a single AWS account using CloudFormation. The Administrator must develop a unified template that can be reused for multiple environments instead of manually copying and pasting the same configurations into the template. The dedicated template will be used and referenced from within other templates in the same AWS Region. If the template has been updated, any stack that is referencing it will automatically use the updated configuration.</p><p>How can the Administrator meet this requirement?</p><p><strong>Answer</strong>: Use Nested Stacks.</p><p>Nested stacks are stacks created as part of other stacks. You can create a nested stack within another stack by using the <code>AWS::CloudFormation::Stack</code> resource.</p><p>As your infrastructure grows, common patterns can emerge in which you declare the same components in multiple templates. You can separate out these commons components and create dedicated templates for them. Then use the resource in your template to reference other templates, creating nested stacks.</p><p>For example, assume that you have a load balancer configuration that you use for most of your stacks. Instead of copying and pasting the same configurations into your templates, you can create a dedicated template for the load balancer. Then, you just use the <code>AWS::CloudFormation::Stack</code> resource to reference that template from within other templates.</p><p>If the load balancer template is updated, any stack that is referencing it will use the updated load balancer (only after you update the stack). In addition to simplifying updates, this approach lets you use experts to create and maintain components that you might not necessarily be familiar with. All you need to do is reference their templates.</p><p>StackSets would be incorrect here because a stack set simply lets you create stacks in AWS accounts across regions by using a single AWS CloudFormation template. The scenario mentioned that the cloud resources are in a single AWS account and also, the dedicated template will be referenced from within other templates in the same AWS Region. For this kind of situation, using a nested stack is more suitable than StackSets.</p><p>ChangeSets would also be incorrect because a ChangeSet is primarily used to preview how the proposed changes to a stack might impact your running resources in AWS.</p><p>StackPolicies is also incorrect because a StackPolicy is commonly used to prevent stack resources from being unintentionally updated or deleted during a stack update. A stack policy is a JSON document that defines the update actions that can performed on designated resources.</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3></h3><ul class=backlinks><li><a href=/notes/aws/aws-wiki/ data-ctx=CloudFormation data-src=/notes/aws/aws-wiki class=internal-link>AWS Wiki</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3></h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://wiki.connerv.com/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p></p><ul><li><a href=https://wiki.connerv.com/></a></li></ul></footer></div></div></body></html>